{"hash":"f81f61a97dc3face0ac4d7ff528417acd696d55a","data":{"blogPost":{"id":"2b8ea4e6881389fcb72c0f248475f19a","title":"Local Development Environment with Docker for PHP","date":"May 26, 2017","content":"<p><strong><em>Setting Docker, Portainer, Nginx, PHP and Composer</em></strong></p>\n<p>If you work with different language, tools or technology its really hard some time to manage all these different environments in local machine. Docker is a great tool which give us isolated environment to build our application with required tools and libraries without messing with the host machine. You can package up an application with all of the parts it needs, such as libraries and other dependencies, and run it on any machine which have docker installed without installing a single piece of software. You can use different version of any tools separately without any hassle. So let’s see how can we use docker to setup our development environment to build application with Laravel.</p>\n<section><h3 id=\"install-docker\"><a href=\"#install-docker\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Install docker</h3><p>I’m using antergos which is arch-linux based os, so installation instructions step below are for arch-linux distro. If you are on Mac or Windows or any other linux distro visit <a href=\"https://www.docker.com/community-edition#download\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a> for installation instruction.</p><pre class=\"language-text\"><code class=\"language-text\">$ sudo pacman -S docker</code></pre><p>To start the docker service (for any linux OS that use systemctl)</p><pre class=\"language-text\"><code class=\"language-text\">$ sudo systemctl start docker.service</code></pre><p>To start on system boot</p><pre class=\"language-text\"><code class=\"language-text\">$ sudo systemctl enable docker.service</code></pre></section>\n<section><h3 id=\"install-portainer\"><a href=\"#install-portainer\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Install Portainer</h3><p>Portainer is a container which gives a nice ui dashboard to use docker easily. We’ll create and run the portainer container like below</p><pre class=\"language-text\"><code class=\"language-text\">$ sudo docker run -d --name portainer -p 80:9000 -v /var/run/docker.sock:/var/run/docker.sock portainer/portainer</code></pre><p>Above will create a container from portainer image and then run it in background ( -d flag make the container run in background). The command will search for the portainer image in local machine and if it doesn’t find the image then it will pull the image from docker image registry. We’ll run the container in port 9000 so port 9000 should be available, but if you want to use any other port than specify it via the -p flag ( -p 8080:9000 ). Also notice that we have named our container portainer with — name flag. You can name your container whatever you want. When the download is complete we can check that the container is running by $ docker ps command. It’ll show a list of all the running container</p><pre class=\"language-text\"><code class=\"language-text\">CONTAINER ID        IMAGE                 COMMAND             CREATED             STATUS              PORTS                    NAMES\n1f5bb115d327        portainer/portainer   &quot;/portainer&quot;        5 seconds ago         Up 1 second         0.0.0.0:9000-&gt;9000/tcp   portainer</code></pre><p>Now you can visit the dashboard by visiting localhost in your browser. You’ll see below screen</p><p><img src=\"https://cdn-images-1.medium.com/max/2644/1*IiMm3jKgkKHpoWUXMdQCSg.png\"></p><p>Provide a password for admin user account and then login to the dashboard. You’ll see a screen like below.</p><p><img src=\"https://cdn-images-1.medium.com/max/2648/1*WkN1z_PM0cHqNpD_tJzLKw.png\"></p><p>Select the first one and connect, you’ll see a nice dashboard</p><p><img src=\"https://cdn-images-1.medium.com/max/2642/1*iiMMDvavsXI1S_KdvrWQIA.png\"></p></section>\n<section><h3 id=\"create-a-php-network\"><a href=\"#create-a-php-network\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Create a PHP network</h3><p>First we will create a network for php application only. Click the network menu from sidebar and then give it some name like php and click create.</p><p><img src=\"https://cdn-images-1.medium.com/max/2482/1*cVDl1WRrjx5lpluCRpt1Ug.png\" alt=\"Create a php network\"><em>Create a php network</em></p></section>\n<section><h3 id=\"install-nginx\"><a href=\"#install-nginx\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Install Nginx</h3><p>First we will create a container as our server and we’ll use official nginx image from docker hub. Go to Containers page from sidebar menu and click on Add Container button</p><p><img src=\"https://cdn-images-1.medium.com/max/2646/1*FjabcxJNQtHKD9dgtrP27w.png\" alt=\"Add New Container\"><em>Add New Container</em></p><p>Let’s give our container a name of server and the image name which is nginx. Click the publish all exposed ports which’ll expose port 80. Next click map additional port and map our host machine port 80 to container port 80 like below</p><p><img src=\"https://cdn-images-1.medium.com/max/2072/1*LbOqkYrRA3RlEBiMyIMwLA.png\" alt=\"Map host port 80 to container port 80\"><em>Map host port 80 to container port 80</em></p><p>Next create two folders where you will keep your projects. This can be anywhere in your file system. One folders is to keep our application source code and the other is for nginx configuration.</p><p><img src=\"https://cdn-images-1.medium.com/max/2000/1*ZUYYe0X6Psy8NsqtuhDJFw.png\"></p><p>Now under Advanced Container Settings click the volume tab and bind sites directory to /var/www in container and nginx-conf directory to /etc/nginx/conf.d .</p><p><img src=\"https://cdn-images-1.medium.com/max/2432/1*TWBD6U3WvslSYpjjZegxFw.png\"></p><p>Next select the php network we created earlier in network tab. Finally hit the start container button. First portainer will pull the nginx image from registry and then start the container</p><p><img src=\"https://cdn-images-1.medium.com/max/2090/1*qyle5bNsvQaeVH1BOEV2sA.png\"></p></section>\n<section><h3 id=\"install-php-fpm\"><a href=\"#install-php-fpm\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Install PHP-FPM</h3><p>Next we will install php fpm to serve our php application. We’ll create a container using official php-fpm image.</p><p><img src=\"https://cdn-images-1.medium.com/max/2478/1*tBMvHo1vmNVLAnSvoq3GPA.png\"></p><p>We don’t need to bind any port from our host machine to the container, nginx will send traffic to php-fpm, we just need to select the php network in network tab.</p><p><img src=\"https://cdn-images-1.medium.com/max/2418/1*iMBk3-YUMDOonZCqoG1HVA.png\"></p><p>Also we need to map our sites directory to the /var/www directory in the container.</p><p><img src=\"https://cdn-images-1.medium.com/max/2410/1*oUUX9GcaQLH48ZOIoGX1aw.png\"></p><p>Finally in Command tabs put /var/www as value in Working Dir field</p><p><img src=\"https://cdn-images-1.medium.com/max/2414/1*o67Xa35i5hib1OqrYv6i6Q.png\"></p><p>Now start the container by hitting start container button.</p><p><img src=\"https://cdn-images-1.medium.com/max/2646/1*pMM_WxHLiE8mnpVzrTbkNg.png\"></p></section>\n<section><h3 id=\"add-application\"><a href=\"#add-application\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Add Application</h3><p>Let’s try to add our first php website. First add a hello.conf file inside nginx-conf directory with below contents</p><pre class=\"language-text\"><code class=\"language-text\">server {\n    listen 80;\n\n    server_name hello.local;\n\n    client_max_body_size 108M;\n\n    access_log /var/log/nginx/hello.access.log;\n    error_log /var/log/nginx/hello.error.log;\n\n    root /var/www/hello/public;\n    index index.php;\n\n    if (!-e $request_filename) {\n        rewrite ^.*$ /index.php last;\n    }\n\n    location ~ \\.php$ {\n        fastcgi_pass php:9000;\n        fastcgi_index index.php;\n        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n        fastcgi_param PHP_VALUE &quot;error_log=/var/log/nginx/hello-php.log&quot;;\n        fastcgi_buffers 16 16k;\n        fastcgi_buffer_size 32k;\n        include fastcgi_params;\n    }\n}</code></pre><p>This file is for routing traffic to php-fpm. Next add a index.php file inside sites/hello/public directory with following contents</p><pre class=\"language-text\"><code class=\"language-text\">&lt;?php\nphpinfo();</code></pre><p>And finally add a domain for our site in /etc/hosts file</p><pre class=\"language-text\"><code class=\"language-text\">127.0.0.1    hello.local</code></pre><p>Now visit <a href=\"http://hello.local\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">http://hello.local</a> and you’ll see</p><p><img src=\"https://cdn-images-1.medium.com/max/2644/1*VGJciA8oO9v10HDGF6aAQQ.png\"></p><p>Now let’s add another site, the procedure is same. First we add conf file for nginx configuration and then add our code in a directory under sites and finally add a domain for that site in /etc/hosts file.</p></section>\n<section><h3 id=\"install-php-extensions\"><a href=\"#install-php-extensions\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Install PHP Extensions</h3><p>By default only few extensions are installed in the container. If we want we can install more extensions. First let’s connect to the bash terminal of our php container. If you visit the container page you’ll see a console link, click it</p><p><img src=\"https://cdn-images-1.medium.com/max/2406/1*skgNxzuS_2Si_UlyrCbR9A.png\"></p><p>You’ll see a connect button to connect to the bash, click it and you’ll be at /var/www directory.</p><p><img src=\"https://cdn-images-1.medium.com/max/2642/1*3t0MU2VcAo_wHjgwZ6z9-g.png\"></p><p>Now let’s install pdo_mysql extension to use mysql pdo driver by following command</p><pre class=\"language-text\"><code class=\"language-text\">$ docker-php-ext-install pdo_mysql</code></pre><p>We’ll also install <code class=\"language-text\">gd</code> and <code class=\"language-text\">ext-zip</code> extensions</p><pre class=\"language-text\"><code class=\"language-text\">$ docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ &amp;&amp; docker-php-ext-install gd\n\n$ apt-get install libzip-dev &amp;&amp; docker-php-ext-install zip</code></pre><p>You can install other extensions in similar way. After installing any extension restart the container.</p></section>\n<section><h3 id=\"install-composer\"><a href=\"#install-composer\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Install Composer</h3><p>Before we install composer first install zip &#x26; unzip package which’ll be used by composer for laravel installation.</p><pre class=\"language-text\"><code class=\"language-text\">$ apt-get update &amp;&amp; apt-get install zip unzip</code></pre><p>And now install composer</p><pre class=\"language-text\"><code class=\"language-text\">$ curl -sS [https://getcomposer.org/installer](https://getcomposer.org/installer) | php -- --install-dir=/usr/bin/ --filename=composer</code></pre><p>Let’s check composer is installed and in our path</p><pre class=\"language-text\"><code class=\"language-text\">$ composer --version\nComposer version 1.4.2 2017-03-10 09:29:45</code></pre></section>\n<section><h3 id=\"install-laravel\"><a href=\"#install-laravel\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Install Laravel</h3><p>Lets install our first laravel application by running following command</p><pre class=\"language-text\"><code class=\"language-text\">$ composer create-project --prefer-dist laravel/laravel example</code></pre><p>It’ll create a new laravel app inside example directory. To make it accessible we have to create a example.conf and add example.local domain in /etc/hosts file. Also we need to change the owner of storage and boostrap folder like below</p><pre class=\"language-text\"><code class=\"language-text\">$ chown -R www-data:www-data storage bootstrap</code></pre><p>Now if we visit example.local in the browser we’ll see</p><p><img src=\"https://cdn-images-1.medium.com/max/2648/1*0LLdZWXfbqAz8xUi8PomHA.png\"></p><p>Adding another application will be same as before: 1) create a new laravel app inside sites directory, 2) add a new .conf file for that application, 3) add a domain in /etc/hosts 4) change owner of storage and bootstrap folder to www-data .</p></section>\n<section><h3 id=\"conclusion\"><a href=\"#conclusion\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Conclusion</h3><p>We have one piece of the puzzle still left, that is database. We’ll see in next post how to add any database to our application and persist the data and also some other tools like redis etc. We’ll also see how can we use another php version to test the same application. Stay tuned!</p><section><h4 id=\"part-2\"><a href=\"#part-2\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a><a href=\"/local-development-environment-with-docker-for-php-2\">Part-2</a></h4></section></section>\n","timeToRead":6}},"context":{}}